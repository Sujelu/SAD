<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboPlinko Xtreme</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
        }
        canvas {
            display: block;
            background: #111;
        }
        .overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .overlay h1 {
            font-size: 72px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            animation: glitch 2s infinite;
        }
        @keyframes glitch {
            0%, 100% { text-shadow: 0 0 20px #0ff, 0 0 40px #0ff; }
            50% { text-shadow: 0 0 30px #f0f, 0 0 60px #f0f; }
        }
        button {
            padding: 18px 40px;
            font-size: 28px;
            font-weight: bold;
            color: #000;
            background: linear-gradient(45deg, #0ff, #0f0);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px #0ff;
        }
        button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px #0ff;
        }
        #info {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 20px;
            z-index: 50;
        }
        .score-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 24px;
            border-radius: 12px;
            border: 2px solid #0ff;
            font-size: 20px;
            font-weight: bold;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 0 15px #0ff;
        }
        .score-zone {
            position: absolute;
            bottom: 0;
            height: 60px;
            width: 100%;
            display: flex;
            border-top: 3px solid #0ff;
        }
        .score-zone div {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.8);
            border-left: 1px solid #0ff;
            border-right: 1px solid #0ff;
            text-shadow: 0 0 10px #fff;
        }
        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 30px yellow, 0 0 60px orange;
            opacity: 0;
            pointer-events: none;
            z-index: 90;
        }
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, yellow, orange, red);
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.6s forwards;
            z-index: 80;
        }
        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        .score-popup {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            color: gold;
            text-shadow: 0 0 10px #ff0;
            pointer-events: none;
            animation: floatUp 1s forwards;
            z-index: 70;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .combo-text {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: #ff0;
            text-shadow: 0 0 20px #ff0;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 60;
        }
    </style>
</head>
<body>

    <canvas id="plinkoCanvas"></canvas>

    <!-- TITLE SCREEN -->
    <div class="overlay" id="startOverlay">
        <h1>ROBOPLINKO XTREME</h1>
        <h1>S.A.D.</h1>
        <button id="startButton">START GAME</button>
        <div style="margin-top: 30px; color: #0ff; font-size: 20px;">
            HI-SCORE: <span id="hiScoreDisplay">000000</span>
        </div>
    </div>

    <!-- GAME OVER -->
    <div class="overlay" id="gameOverOverlay" style="display: none;">
        <h1>GAME OVER</h1>
        <div style="margin: 20px 0; font-size: 32px; color: gold;">
            SCORE: <span id="finalScore">0</span>
        </div>
        <button id="restartButton">VENDETTA</button>
    </div>

    <!-- HUD -->
    <div id="info">
        <div class="score-box">Palline: <span id="remainingBalls">30</span></div>
        <div class="score-box">Score: <span id="score">0</span></div>
        <div class="score-box">Picco: <span id="highScore">0</span></div>
        <div class="score-box">Livello: <span id="level">1</span></div>
    </div>

    <!-- SCORE ZONES -->
    <div class="score-zone">
        <div>-500</div>
        <div>+10</div>
        <div>+20</div>
        <div>150</div>
        <div>-1000</div>
        <div>5000</div>
        <div>-1000</div>
        <div>150</div>
        <div>40</div>
        <div>75</div>
        <div>-500</div>
    </div>

    <!-- LEVEL UP -->
    <div class="level-up" id="levelUpMessage">LEVEL UP!</div>

    <!-- COMBO -->
    <div class="combo-text" id="comboText"></div>

    <!-- AUDIO -->
    <audio id="bonusSound" src="https://github.com/Sujelu/SAD/bonus_complete.mp3" preload="auto"></audio>
    <audio id="explosionSound" src="https://github.com/Sujelu/SAD/explosion.wav" preload="auto"></audio>

    <script>
        // === ELEMENTI DOM ===
        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');
        const startOverlay = document.getElementById('startOverlay');
        const startButton = document.getElementById('startButton');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const restartButton = document.getElementById('restartButton');
        const remainingBallsDisplay = document.getElementById('remainingBalls');
        const scoreDisplay = document.getElementById('score');
        const highScoreDisplay = document.getElementById('highScore');
        const hiScoreDisplay = document.getElementById('hiScoreDisplay');
        const levelDisplay = document.getElementById('level');
        const levelUpMessage = document.getElementById('levelUpMessage');
        const comboText = document.getElementById('comboText');
        const finalScoreDisplay = document.getElementById('finalScore');
        const bonusSound = document.getElementById('bonusSound');
        const explosionSound = document.getElementById('explosionSound');

        // === COSTANTI ===
        const CHIODINO_RADIUS = 5;
        const PALLINA_RADIUS = 5;
        let GRAVITY_Y = 0.5;
        const ZONE_HEIGHT = 60;
        const SCORE_ZONES = [-500, 10, 20, 150, -1000, 5000, -1000, 150, 40, 75, -500];

        // === LIVELLI TEMATICI ===
        const LEVEL_THEMES = [
            { name: "ROBOT FACTORY", bg: "#111", peg: "#888", ball: "orange", glow: "#555" },
            { name: "NEON CIRCUIT", bg: "#0a0a23", peg: "#00ff41", ball: "#00ffff", glow: "#0f0" },
            { name: "LASER LAB", bg: "#230023", peg: "#ff00ff", ball: "#ff4400", glow: "#f0f" },
            { name: "XTREME CHAOS", bg: "#330000", peg: "#ffff00", ball: "white", glow: "#ff0" }
        ];

        // === VARIABILI GIOCO ===
        let CHIODINI = [], PALLINE = [], BONUS = [], POWERUPS_ACTIVE = [], particles = [];
        let score = 0, highScore = 0, remainingBalls = 30, gameOver = false;
        let currentLevel = 0, levelThreshold = 5000;
        let bonusClickCount = 0, combo = 0, comboMultiplier = 1;
        let shakeIntensity = 0;

        // Carica hi-score da localStorage
        highScore = parseInt(localStorage.getItem('roboPlincoHiScore') || '0');
        highScoreDisplay.innerText = highScore.toString().padStart(6, '0');
        hiScoreDisplay.innerText = highScore.toString().padStart(6, '0');

        // === RESIZE CANVAS ===
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            generateChiodini();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // === GENERA CHIODINI ===
        function generateChiodini() {
            CHIODINI = [];
            const rows = 18;
            const cols = 22;
            const spacingX = canvas.width / cols;
            const spacingY = (canvas.height - ZONE_HEIGHT - 100) / rows;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const offsetX = (y % 2 === 0) ? spacingX / 2 : 0;
                    CHIODINI.push({
                        x: x * spacingX + offsetX,
                        y: y * spacingY + 80,
                        glow: Math.random() * 0.7 + 0.3
                    });
                }
            }
        }

        // === CREA PALLINA ===
        function createPallina(x) {
            if (remainingBalls <= 0 && !gameOver) return;
            PALLINE.push({
                x, y: 10,
                speedX: (Math.random() - 0.5) * 1,
                speedY: 0,
                landed: false,
                color: LEVEL_THEMES[currentLevel].ball
            });
            if (!gameOver) remainingBalls--;
            remainingBallsDisplay.innerText = remainingBalls;
            combo++;
            showCombo();
        }

        // === CREA BONUS ===
        function createBonus() {
            const types = ['circle', 'square', 'triangle'];
            const type = types[Math.floor(Math.random() * types.length)];
            const size = type === 'circle' ? 20 : (type === 'square' ? 30 : 25);
            BONUS.push({
                x: Math.random() * (canvas.width - size),
                y: Math.random() * (canvas.height - ZONE_HEIGHT - size),
                type, size, clicked: 0,
                speedX: (Math.random() - 0.5) * 2,
                speedY: (Math.random() - 0.5) * 2
            });
        }

        // === CREA POWER-UP ===
        function createPowerUp() {
            const types = ['DOUBLE', 'SLOW', 'MULTI'];
            const type = types[Math.floor(Math.random() * types.length)];
            const color = type === 'DOUBLE' ? 'gold' : (type === 'SLOW' ? '#00f' : '#0f0');
            POWERUPS_ACTIVE.push({ x: Math.random() * canvas.width, y: 0, type, color, vy: 2 });
        }

        // === PARTICELLE ===
        function createParticles(x, y, count = 15, color = 'yellow') {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 1,
                    color
                });
            }
        }

        // === UPDATE PALLINE ===
        function updatePalline() {
            PALLINE = PALLINE.filter(p => {
                if (p.landed) return true;
                p.speedY += GRAVITY_Y;
                p.y += p.speedY;
                p.x += p.speedX;

                if (p.x < PALLINA_RADIUS || p.x > canvas.width - PALLINA_RADIUS) {
                    p.speedX *= -0.9;
                }

                CHIODINI.forEach(c => {
                    const dist = Math.hypot(c.x - p.x, c.y - p.y);
                    if (dist < CHIODINO_RADIUS + PALLINA_RADIUS) {
                        p.speedY *= -0.8;
                        p.speedX += (Math.random() - 0.5) * 1.5;
                        createParticles(p.x, p.y, 3, '#fff');
                    }
                });

                if (p.y >= canvas.height - ZONE_HEIGHT) {
                    p.landed = true;
                    const zoneWidth = canvas.width / SCORE_ZONES.length;
                    const zoneIndex = Math.floor(p.x / zoneWidth);
                    let points = SCORE_ZONES[zoneIndex] || 0;
                    const total = points * combo * comboMultiplier;
                    score += total;
                    showScorePopup(p.x, p.y, total > 0 ? `+${total}` : total);
                    combo = 0;
                    hideCombo();
                }
                return p.y < canvas.height + 50;
            });
        }

        // === UPDATE BONUS ===
        function updateBonus() {
            BONUS.forEach(b => {
                b.x += b.speedX;
                b.y += b.speedY;
                if (b.x < 0 || b.x + b.size > canvas.width) b.speedX *= -1;
                if (b.y < 0 || b.y + b.size > canvas.height - ZONE_HEIGHT) b.speedY *= -1;

                ctx.fillStyle = b.type === 'circle' ? '#f00' : (b.type === 'square' ? '#00f' : '#0f0');
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                if (b.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(b.x + b.size/2, b.y + b.size/2, b.size/2, 0, Math.PI*2);
                    ctx.fill();
                    ctx.stroke();
                } else if (b.type === 'square') {
                    ctx.fillRect(b.x, b.y, b.size, b.size);
                    ctx.strokeRect(b.x, b.y, b.size, b.size);
                } else {
                    ctx.beginPath();
                    ctx.moveTo(b.x + b.size/2, b.y);
                    ctx.lineTo(b.x, b.y + b.size);
                    ctx.lineTo(b.x + b.size, b.y + b.size);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                }
            });
        }

        // === UPDATE POWER-UPS ===
        function updatePowerUps() {
            POWERUPS_ACTIVE = POWERUPS_ACTIVE.filter(pu => {
                pu.y += pu.vy;
                ctx.fillStyle = pu.color;
                ctx.strokeStyle = '#fff';
                ctx.beginPath();
                ctx.arc(pu.x, pu.y, 18, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#000';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(pu.type === 'DOUBLE' ? '2X' : pu.type === 'SLOW' ? 'S' : '5', pu.x, pu.y + 4);
                return pu.y < canvas.height;
            });
        }

        // === UPDATE PARTICELLE ===
        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.98;
                p.vy *= 0.98;
                p.life -= 0.02;
                return p.life > 0;
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
            });
            ctx.globalAlpha = 1;
        }

        // === DRAW CHIODINI ===
        function drawChiodini() {
            const theme = LEVEL_THEMES[currentLevel];
            CHIODINI.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x, c.y, CHIODINO_RADIUS, 0, Math.PI*2);
                ctx.fillStyle = theme.peg;
                ctx.shadowColor = theme.glow;
                ctx.shadowBlur = c.glow * 25;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#333';
                ctx.stroke();
            });
        }

        // === DRAW PALLINE ===
        function drawPalline() {
            PALLINE.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, PALLINA_RADIUS, 0, Math.PI*2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.stroke();
            });
        }

        // === UI FUNZIONI ===
        function showScorePopup(x, y, text) {
            const el = document.createElement('div');
            el.className = 'score-popup';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = (y - 20) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function showLevelUp() {
            levelUpMessage.style.opacity = 1;
            setTimeout(() => levelUpMessage.style.opacity = 0, 1500);
        }

        function showCombo() {
            if (combo > 1) {
                comboText.innerText = `COMBO x${combo}`;
                comboText.style.opacity = 1;
            }
        }

        function hideCombo() {
            setTimeout(() => {
                if (combo <= 1) comboText.style.opacity = 0;
            }, 500);
        }

        function applyShake() {
            if (shakeIntensity > 0) {
                const dx = (Math.random() - 0.5) * shakeIntensity;
                const dy = (Math.random() - 0.5) * shakeIntensity;
                ctx.translate(dx, dy);
                shakeIntensity *= 0.88;
            }
        }

        function drawScore() {
            const displayScore = Math.floor(score * comboMultiplier);
            scoreDisplay.innerText = displayScore.toString().padStart(6, '0');
            if (displayScore > highScore) {
                highScore = displayScore;
                highScoreDisplay.innerText = highScore.toString().padStart(6, '0');
                hiScoreDisplay.innerText = highScore.toString().padStart(6, '0');
                localStorage.setItem('roboPlincoHiScore', highScore);
                highScoreDisplay.style.color = 'gold';
                setTimeout(() => highScoreDisplay.style.color = 'white', 2000);
            }
        }

        function checkGameOver() {
            if (remainingBalls <= 0 && PALLINE.every(p => p.landed)) {
                gameOver = true;
                finalScoreDisplay.innerText = Math.floor(score * comboMultiplier);
                gameOverOverlay.style.display = 'flex';
            }
        }

        // === CLICK HANDLER ===
        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Power-up
            for (let i = POWERUPS_ACTIVE.length - 1; i >= 0; i--) {
                const pu = POWERUPS_ACTIVE[i];
                const dist = Math.hypot(pu.x - x, pu.y - y);
                if (dist < 25) {
                    activatePowerUp(pu.type);
                    createParticles(x, y, 25, pu.color);
                    explosionSound.currentTime = 0;
                    explosionSound.play();
                    POWERUPS_ACTIVE.splice(i, 1);
                    break;
                }
            }

            // Bonus
            for (let i = BONUS.length - 1; i >= 0; i--) {
                const b = BONUS[i];
                if (x > b.x && x < b.x + b.size && y > b.y && y < b.y + b.size) {
                    b.clicked++;
                    bonusClickCount++;
                    if (b.clicked >= 3) {
                        BONUS.splice(i, 1);
                        if (b.type === 'triangle') {
                            remainingBalls += 10;
                            remainingBallsDisplay.innerText = remainingBalls;
                            showScorePopup(b.x + b.size/2, b.y, '+10 PALLINE');
                        } else if (b.type === 'circle') {
                            score += 100;
                            showScorePopup(b.x + b.size/2, b.y, '+100');
                        } else {
                            score += 50;
                            showScorePopup(b.x + b.size/2, b.y, '+50');
                        }
                        createExplosion(b.x + b.size/2, b.y + b.size/2);
                        bonusSound.currentTime = 0;
                        bonusSound.play();
                    }
                    if (bonusClickCount >= 10) {
                        for (let j = 0; j < 5; j++) {
                            setTimeout(() => createPallina(Math.random() * canvas.width), j * 100);
                        }
                        bonusClickCount = 0;
                    }
                    break;
                }
            }

            createPallina(x);
        });

        function createExplosion(x, y) {
            const el = document.createElement('div');
            el.className = 'explosion';
            el.style.left = (x - 50) + 'px';
            el.style.top = (y - 50) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        function activatePowerUp(type) {
            if (type === 'DOUBLE') {
                comboMultiplier = 2;
                setTimeout(() => comboMultiplier = 1, 10000);
            } else if (type === 'SLOW') {
                GRAVITY_Y = 0.25;
                setTimeout(() => GRAVITY_Y = 0.5, 5000);
            } else if (type === 'MULTI') {
                remainingBalls += 5;
                remainingBallsDisplay.innerText = remainingBalls;
            }
        }

        // === GAME LOOP ===
        function update() {
            if (gameOver) return;

            ctx.save();
            applyShake();

            // Sfondo
            ctx.fillStyle = LEVEL_THEMES[currentLevel].bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Level up
            if (score >= levelThreshold) {
                currentLevel = Math.min(currentLevel + 1, LEVEL_THEMES.length - 1);
                levelThreshold += 8000;
                levelDisplay.innerText = currentLevel + 1;
                showLevelUp();
                createParticles(canvas.width/2, 100, 60, 'gold');
                shakeIntensity = 15;
                createPowerUp();
            }

            updatePalline();
            updateBonus();
            updatePowerUps();
            updateParticles();

            drawChiodini();
            drawPalline();
            drawParticles();

            drawScore();
            checkGameOver();

            ctx.restore();
            requestAnimationFrame(update);
        }

        // === AVVIO ===
        window.addEventListener('load', () => {
            startOverlay.style.display = 'flex';
            gameOverOverlay.style.display = 'none';
        });

        function startGame() {
            score = 0;
            remainingBalls = 30;
            gameOver = false;
            currentLevel = 0;
            levelThreshold = 5000;
            combo = 0;
            comboMultiplier = 1;
            bonusClickCount = 0;
            PALLINE = [];
            BONUS = [];
            POWERUPS_ACTIVE = [];
            particles = [];
            GRAVITY_Y = 0.5;

            generateChiodini();
            createBonus();
            setInterval(createBonus, 30000);

            startOverlay.style.display = 'none';
            gameOverOverlay.style.display = 'none';

            remainingBallsDisplay.innerText = remainingBalls;
            scoreDisplay.innerText = '000000';
            levelDisplay.innerText = '1';

            requestAnimationFrame(update);
        }

        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
    </script>
</body>
</html>
