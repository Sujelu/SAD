<script>
    // === ELEMENTI DOM ===
    const canvas = document.getElementById('plinkoCanvas');
    const ctx = canvas.getContext('2d');
    const startOverlay = document.getElementById('startOverlay');
    const startButton = document.getElementById('startButton');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const restartButton = document.getElementById('restartButton');
    const remainingBallsDisplay = document.getElementById('remainingBalls');
    const scoreDisplay = document.getElementById('score');
    const highScoreDisplay = document.getElementById('highScore');
    const hiScoreDisplay = document.getElementById('hiScoreDisplay');
    const levelDisplay = document.getElementById('level');
    const levelUpMessage = document.getElementById('levelUpMessage');
    const comboText = document.getElementById('comboText');
    const finalScoreDisplay = document.getElementById('finalScore');

    // === AUDIO ===
    const bgMusic = document.getElementById('bgMusic');
    const dropSound = document.getElementById('dropSound');
    const bonusSound = document.getElementById('bonusSound');
    const explosionSound = document.getElementById('explosionSound');
    const levelUpSound = document.getElementById('levelUpSound');
    const powerUpSound = document.getElementById('powerUpSound');

    // === COSTANTI ===
    const CHIODINO_RADIUS = 5;
    const PALLINA_RADIUS = 5;
    let GRAVITY_Y = 0.5;
    const ZONE_HEIGHT = 60;
    const SCORE_ZONES = [-500, 10, 20, 150, -1000, 5000, -1000, 150, 40, 75, -500];

    // === LIVELLI TEMATICI ===
    const LEVEL_THEMES = [
        { name: "ROBOT FACTORY", bg: "#111", peg: "#888", ball: "orange", glow: "#555" },
        { name: "NEON CIRCUIT", bg: "#0a0a23", peg: "#00ff41", ball: "#00ffff", glow: "#0f0" },
        { name: "LASER LAB", bg: "#230023", peg: "#ff00ff", ball: "#ff4400", glow: "#f0f" },
        { name: "XTREME CHAOS", bg: "#330000", peg: "#ffff00", ball: "white", glow: "#ff0" }
    ];

    // === POWER-UPS AGGIUNTI ===
    const POWERUP_TYPES = [
        { type: 'DOUBLE', color: 'gold', icon: '2X', duration: 10000 },
        { type: 'SLOW', color: '#00f', icon: 'S', duration: 8000 },
        { type: 'MULTI', color: '#0f0', icon: '5', duration: 0 },
        { type: 'LIFE', color: '#f00', icon: 'Heart', duration: 0 }, // +1 ogni 3 rimbalzi
        { type: 'BOOM', color: '#ff0', icon: 'Bomb', duration: 0 }
    ];

    // === VARIABILI ===
    let CHIODINI = [], PALLINE = [], BONUS = [], POWERUPS_ACTIVE = [], particles = [];
    let score = 0, highScore = 0, remainingBalls = 30, gameOver = false;
    let currentLevel = 0, levelThreshold = 5000;
    let bonusClickCount = 0, combo = 0, comboMultiplier = 1;
    let shakeIntensity = 0;
    let lifeStealCounter = 0;
    let isMusicPlaying = false;

    // === CARICA HI-SCORE ===
    highScore = parseInt(localStorage.getItem('roboPlincoHiScore') || '0');
    highScoreDisplay.innerText = highScore.toString().padStart(6, '0');
    hiScoreDisplay.innerText = highScore.toString().padStart(6, '0');

    // === RESIZE ===
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        generateChiodini();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // === GENERA CHIODINI ===
    function generateChiodini() {
        CHIODINI = [];
        const rows = 18;
        const cols = 22;
        const spacingX = canvas.width / cols;
        const spacingY = (canvas.height - ZONE_HEIGHT - 100) / rows;
        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const offsetX = (y % 2 === 0) ? spacingX / 2 : 0;
                CHIODINI.push({
                    x: x * spacingX + offsetX,
                    y: y * spacingY + 80,
                    glow: Math.random() * 0.7 + 0.3
                });
            }
        }
    }

    // === CREA PALLINA ===
    function createPallina(x) {
        if (remainingBalls <= 0 && !gameOver) return;
        PALLINE.push({
            x, y: 10,
            speedX: (Math.random() - 0.5) * 1,
            speedY: 0,
            landed: false,
            color: LEVEL_THEMES[currentLevel].ball,
            bounceCount: 0
        });
        if (!gameOver) remainingBalls--;
        remainingBallsDisplay.innerText = remainingBalls;
        combo++;
        showCombo();
        dropSound.currentTime = 0;
        dropSound.play().catch(() => {});
    }

    // === CREA BONUS ===
    function createBonus() {
        const types = ['circle', 'square', 'triangle'];
        const type = types[Math.floor(Math.random() * types.length)];
        const size = type === 'circle' ? 20 : (type === 'square' ? 30 : 25);
        BONUS.push({
            x: Math.random() * (canvas.width - size),
            y: Math.random() * (canvas.height - ZONE_HEIGHT - size),
            type, size, clicked: 0,
            speedX: (Math.random() - 0.5) * 2,
            speedY: (Math.random() - 0.5) * 2
        });
    }

    // === CREA POWER-UP ===
    function createPowerUp() {
        const pu = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
        POWERUPS_ACTIVE.push({ 
            x: Math.random() * canvas.width, 
            y: 0, 
            type: pu.type, 
            color: pu.color, 
            icon: pu.icon,
            vy: 2 
        });
    }

    // === PARTICELLE ===
    function createParticles(x, y, count = 15, color = 'yellow') {
        for (let i = 0; i < count; i++) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                life: 1,
                color
            });
        }
    }

    // === UPDATE PALLINE ===
    function updatePalline() {
        PALLINE = PALLINE.filter(p => {
            if (p.landed) return true;
            p.speedY += GRAVITY_Y;
            p.y += p.speedY;
            p.x += p.speedX;

            if (p.x < PALLINA_RADIUS || p.x > canvas.width - PALLINA_RADIUS) {
                p.speedX *= -0.9;
            }

            let bounced = false;
            CHIODINI.forEach(c => {
                const dist = Math.hypot(c.x - p.x, c.y - p.y);
                if (dist < CHIODINO_RADIUS + PALLINA_RADIUS) {
                    p.speedY *= -0.8;
                    p.speedX += (Math.random() - 0.5) * 1.5;
                    p.bounceCount++;
                    bounced = true;
                    createParticles(p.x, p.y, 3, '#fff');
                }
            });

            // LIFE STEAL
            if (p.bounceCount > 0 && p.bounceCount % 3 === 0 && !bounced) {
                remainingBalls++;
                remainingBallsDisplay.innerText = remainingBalls;
                showScorePopup(p.x, p.y, '+1 BALL');
            }

            if (p.y >= canvas.height - ZONE_HEIGHT) {
                p.landed = true;
                const zoneWidth = canvas.width / SCORE_ZONES.length;
                const zoneIndex = Math.floor(p.x / zoneWidth);
                let points = SCORE_ZONES[zoneIndex] || 0;
                const total = points * combo * comboMultiplier;
                score += total;
                showScorePopup(p.x, p.y, total > 0 ? `+${total}` : total);
                combo = 0;
                hideCombo();
            }
            return p.y < canvas.height + 50;
        });
    }

    // === RESTO DEL CODICE (updateBonus, updatePowerUps, ecc.) ===
    // ... (identico al precedente, ma con suoni aggiunti)

    function updateBonus() {
        BONUS.forEach(b => {
            b.x += b.speedX;
            b.y += b.speedY;
            if (b.x < 0 || b.x + b.size > canvas.width) b.speedX *= -1;
            if (b.y < 0 || b.y + b.size > canvas.height - ZONE_HEIGHT) b.speedY *= -1;

            ctx.fillStyle = b.type === 'circle' ? '#f00' : (b.type === 'square' ? '#00f' : '#0f0');
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            if (b.type === 'circle') {
                ctx.beginPath();
                ctx.arc(b.x + b.size/2, b.y + b.size/2, b.size/2, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
            } else if (b.type === 'square') {
                ctx.fillRect(b.x, b.y, b.size, b.size);
                ctx.strokeRect(b.x, b.y, b.size, b.size);
            } else {
                ctx.beginPath();
                ctx.moveTo(b.x + b.size/2, b.y);
                ctx.lineTo(b.x, b.y + b.size);
                ctx.lineTo(b.x + b.size, b.y + b.size);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
        });
    }

    function updatePowerUps() {
        POWERUPS_ACTIVE = POWERUPS_ACTIVE.filter(pu => {
            pu.y += pu.vy;
            ctx.fillStyle = pu.color;
            ctx.strokeStyle = '#fff';
            ctx.beginPath();
            ctx.arc(pu.x, pu.y, 18, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(pu.icon, pu.x, pu.y + 4);
            return pu.y < canvas.height;
        });
    }

    // === ATTIVA POWER-UP ===
    function activatePowerUp(type) {
        powerUpSound.currentTime = 0;
        powerUpSound.play().catch(() => {});

        if (type === 'DOUBLE') {
            comboMultiplier = 2;
            setTimeout(() => comboMultiplier = 1, 10000);
        } else if (type === 'SLOW') {
            GRAVITY_Y = 0.25;
            setTimeout(() => GRAVITY_Y = 0.5, 8000);
        } else if (type === 'MULTI') {
            remainingBalls += 5;
            remainingBallsDisplay.innerText = remainingBalls;
        } else if (type === 'BOOM') {
            // Esplosione a catena
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const zone = Math.floor(Math.random() * SCORE_ZONES.length);
                    score += 500;
                    createParticles(canvas.width * (zone + 0.5) / SCORE_ZONES.length, canvas.height - 30, 30, 'yellow');
                    explosionSound.currentTime = 0;
                    explosionSound.play().catch(() => {});
                }, i * 200);
            }
        }
    }

    // === LEVEL UP ===
    if (score >= levelThreshold) {
        currentLevel = Math.min(currentLevel + 1, LEVEL_THEMES.length - 1);
        levelThreshold += 8000;
        levelDisplay.innerText = currentLevel + 1;
        showLevelUp();
        createParticles(canvas.width/2, 100, 60, 'gold');
        shakeIntensity = 15;
        createPowerUp();
        levelUpSound.currentTime = 0;
        levelUpSound.play().catch(() => {});
    }

    // === CLICK ===
    canvas.addEventListener('click', e => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Power-up
        for (let i = POWERUPS_ACTIVE.length - 1; i >= 0; i--) {
            const pu = POWERUPS_ACTIVE[i];
            const dist = Math.hypot(pu.x - x, pu.y - y);
            if (dist < 25) {
                activatePowerUp(pu.type);
                createParticles(x, y, 25, pu.color);
                POWERUPS_ACTIVE.splice(i, 1);
                break;
            }
        }

        // Bonus
        for (let i = BONUS.length - 1; i >= 0; i--) {
            const b = BONUS[i];
            if (x > b.x && x < b.x + b.size && y > b.y && y < b.y + b.size) {
                b.clicked++;
                bonusClickCount++;
                if (b.clicked >= 3) {
                    BONUS.splice(i, 1);
                    bonusSound.currentTime = 0;
                    bonusSound.play().catch(() => {});
                    // ... (logica bonus)
                }
                break;
            }
        }

        createPallina(x);
    });

    // === START GAME ===
    function startGame() {
        // ... reset
        bgMusic.currentTime = 0;
        bgMusic.play().catch(() => {});
        isMusicPlaying = true;
        requestAnimationFrame(update);
    }

    // Mute toggle
    document.addEventListener('keydown', e => {
        if (e.key === 'm') {
            if (isMusicPlaying) {
                bgMusic.pause();
            } else {
                bgMusic.play().catch(() => {});
            }
            isMusicPlaying = !isMusicPlaying;
        }
    });

    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);
</script>
