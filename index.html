<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.D. | RoboPlinko</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { height: 100%; overflow: hidden; font-family: 'Courier New', monospace; background: #000; color: #fff; }
        canvas { display: block; background: #111; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .overlay h1 { font-size: 70px; margin-bottom: 20px; text-shadow: 0 0 30px #0ff, 0 0 60px #0ff; animation: glitch 1.5s infinite; }
        @keyframes glitch { 0%,100% { text-shadow: 0 0 30px #0ff; } 50% { text-shadow: 0 0 40px #f0f; } }
        button { padding: 18px 40px; font-size: 28px; font-weight: bold; color: #000; background: linear-gradient(45deg, #0ff, #0f0); border: none; border-radius: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 30px #0ff; }
        button:hover { transform: scale(1.15); box-shadow: 0 0 50px #0ff; }
        #info { position: absolute; top: 15px; left: 15px; display: flex; gap: 15px; z-index: 50; }
        .score-box { background: rgba(0,0,0,0.7); padding: 12px 22px; border-radius: 12px; border: 2px solid #0ff; font-size: 20px; font-weight: bold; min-width: 140px; text-align: center; box-shadow: 0 0 20px #0ff; }
        .score-zone { position: absolute; bottom: 0; height: 70px; width: 100%; display: flex; border-top: 4px solid #0ff; }
        .score-zone div { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; background: rgba(0,0,0,0.8); border-left: 1px solid #0ff; border-right: 1px solid #0ff; text-shadow: 0 0 12px #fff; }
        .score-zone div.ball-zone { background: rgba(0,255,0,0.3); color: #0f0; text-shadow: 0 0 15px #0f0; }
        .level-up { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 90px; font-weight: bold; color: gold; text-shadow: 0 0 40px yellow, 0 0 80px orange; opacity: 0; pointer-events: none; z-index: 90; }
        .score-popup { position: absolute; font-weight: bold; font-size: 28px; color: gold; text-shadow: 0 0 15px #ff0; pointer-events: none; animation: floatUp 1.2s forwards; z-index: 70; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        .combo-text { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); font-size: 56px; font-weight: bold; color: #ff0; text-shadow: 0 0 25px #ff0; opacity: 0; transition: opacity 0.3s; z-index: 60; }
        .sad-logo { position: absolute; top: 15px; right: 15px; font-size: 16px; color: #0ff; text-shadow: 0 0 15px #0ff; z-index: 50; opacity: 0.9; }
        .track-info { position: absolute; bottom: 90px; left: 20px; font-size: 16px; color: #0ff; text-shadow: 0 0 10px #0ff; z-index: 50; }
        .debug { position: absolute; top: 10px; right: 10px; color: #0f0; font-size: 14px; z-index: 100; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <canvas id="plinkoCanvas"></canvas>

    <div class="sad-logo">S.A.D. ARCADE<br>by Dr.Sujelu</div>
    <div class="debug" id="debug">Sujelu Arcade Division/div>

    <div class="overlay" id="startOverlay">
        <h1>RoboPlinko ExtremE</h1>
        <h2 style="font-size: 32px; color: #0ff; margin-bottom: 20px;">S.A.D.</h2>
        <button id="startButton">INIZIA</button>
        <div style="margin-top: 30px; color: #0ff; font-size: 20px;">
            HI-SCORE: <span id="hiScoreDisplay">000000</span>
        </div>
    </div>

    <div class="overlay" id="gameOverOverlay" style="display: none;">
        <h1>GAME OVER</h1>
        <div style="margin: 20px 0; font-size: 36px; color: gold;">
            SCORE: <span id="finalScore">0</span>
        </div>
        <button id="restartButton">RIVINCITA</button>
    </div>

    <div id="info">
        <div class="score-box">Palline: <span id="remainingBalls">50</span></div>
        <div class="score-box">Score: <span id="score">0</span></div>
        <div class="score-box">Picco: <span id="highScore">0</span></div>
        <div class="score-box">Livello: <span id="level">1</span></div>
    </div>

    <div class="score-zone">
        <div>-500</div><div>+10</div><div>+20</div><div class="ball-zone">+1 BALL</div>
        <div>-1000</div><div>5000</div><div>-1000</div><div class="ball-zone">+1 BALL</div>
        <div>40</div><div>75</div><div class="ball-zone">+1 BALL</div>
    </div>

    <div class="level-up" id="levelUpMessage">LEVEL UP!</div>
    <div class="combo-text" id="comboText"></div>
    <div class="track-info" id="trackInfo">Livello 1 – Intro</div>

    <!-- AUDIO – PERCORSO CORRETTO: SAD/audio/ -->
    <audio id="dropSound" preload="auto"></audio>
    <audio id="bounce1" preload="auto"></audio>
    <audio id="bounce2" preload="auto"></audio>
    <audio id="bounce3" preload="auto"></audio>
    <audio id="bounce4" preload="auto"></audio>
    <audio id="bounce5" preload="auto"></audio>
    <audio id="bonusClickSound" preload="auto"></audio>
    <audio id="bonusCompleteSound" preload="auto"></audio>
    <audio id="powerupCollectSound" preload="auto"></audio>
    <audio id="explosionSound" preload="auto"></audio>
    <audio id="levelUpSound" preload="auto"></audio>
    <audio id="gameOverSound" preload="auto"></audio>
    <audio id="bgTrack" preload="auto" loop></audio>

    <script>
        // === ELEMENTI ===
        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');
        const debug = document.getElementById('debug');
        const startOverlay = document.getElementById('startOverlay');
        const startButton = document.getElementById('startButton');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const restartButton = document.getElementById('restartButton');
        const remainingBallsDisplay = document.getElementById('remainingBalls');
        const scoreDisplay = document.getElementById('score');
        const highScoreDisplay = document.getElementById('highScore');
        const hiScoreDisplay = document.getElementById('hiScoreDisplay');
        const levelDisplay = document.getElementById('level');
        const levelUpMessage = document.getElementById('levelUpMessage');
        const comboText = document.getElementById('comboText');
        const finalScoreDisplay = document.getElementById('finalScore');
        const trackInfo = document.getElementById('trackInfo');

        // === VARIABILI ===
        let score = 0, highScore = 0, remainingBalls = 50, gameOver = false;
        let currentLevel = 1, levelThreshold = 8000;
        let combo = 0, comboMultiplier = 1;
        let shakeIntensity = 0;
        let audioUnlocked = false;
        let currentBounce = 0;

        // === AUDIO – PERCORSO CORRETTO: SAD/audio/ ===
        const audioFiles = {
            dropSound: "drop.wav",
            bounce1: "bounce1.wav",
            bounce2: "bounce2.wav",
            bounce3: "bounce3.wav",
            bounce4: "bounce4.wav",
            bounce5: "bounce5.wav",
            bonusClickSound: "bonus_click.wav",
            bonusCompleteSound: "bonus_complete.mp3",
            powerupCollectSound: "powerup_collect.wav",
            explosionSound: "explosion.wav",
            levelUpSound: "level_up.wav",
            gameOverSound: "game_over.mp3"
        };

        const sounds = {};
        Object.keys(audioFiles).forEach(key => {
            const audio = document.getElementById(key);
            audio.src = audioFiles[key];
            audio.load();
            sounds[key] = audio;
        });

        function unlockAudio() {
            if (audioUnlocked) return;
            audioUnlocked = true;
            debug.innerText = "Audio: Sbloccato!";
            debug.style.color = "#0f0";
            playSound('dropSound');
            playBgTrack();
        }

        function playSound(id) {
            if (!audioUnlocked || !sounds[id]) return;
            sounds[id].currentTime = 0;
            sounds[id].play().catch(() => {});
        }

        function playBounce() {
            if (!audioUnlocked) return;
            const keys = ['bounce1', 'bounce2', 'bounce3', 'bounce4', 'bounce5'];
            const sound = sounds[keys[currentBounce % 5]];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
            currentBounce++;
        }

        const bgTracks = ["bg1.mp3", "bg2.mp3", "bg3.mp3", "bg4.mp3"];
        function playBgTrack() {
            if (!audioUnlocked) return;
            const track = bgTracks[(currentLevel - 1) % bgTracks.length];
            const bg = sounds.bgTrack;
            bg.src = "SAD/audio/" + track;  // PERCORSO CORRETTO
            bg.load();
            bg.volume = 0.6;
            bg.play().catch(() => {});
            trackInfo.innerText = `Livello ${currentLevel} – ${track}`;
        }

        // === FISICA ===
        const CHIODINO_RADIUS = 5, PALLINA_RADIUS = 6;
        let GRAVITY_Y = 0.5;
        const ZONE_HEIGHT = 70;
        const SCORE_ZONES = [-500, 10, 20, 0, -1000, 5000, -1000, 0, 40, 75, 0];
        const BALL_ZONES = [3, 7, 10];

        let CHIODINI = [], PALLINE = [], particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            generateChiodini();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function generateChiodini() {
            CHIODINI = [];
            const rows = 18, cols = 22;
            const spacingX = canvas.width / cols;
            const spacingY = (canvas.height - ZONE_HEIGHT - 100) / rows;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const offsetX = (y % 2 === 0) ? spacingX / 2 : 0;
                    const bouncePower = 0.8 + (currentLevel - 1) * 0.05;
                    CHIODINI.push({ x: x * spacingX + offsetX, y: y * spacingY + 80, bounce: bouncePower });
                }
            }
        }

        function createPallina(x) {
            if (remainingBalls <= 0 || gameOver) return;
            PALLINE.push({
                x, y: 10,
                speedX: (Math.random() - 0.5) * 2,
                speedY: 0,
                landed: false,
                color: `hsl(${currentLevel * 60}, 100%, 60%)`
            });
            remainingBalls--;
            remainingBallsDisplay.innerText = remainingBalls;
            combo++;
            showCombo();
            playSound('dropSound');
        }

        function updatePalline() {
            PALLINE = PALLINE.filter(p => {
                if (p.landed) return true;
                p.speedY += GRAVITY_Y;
                p.y += p.speedY;
                p.x += p.speedX;

                if (p.x < PALLINA_RADIUS || p.x > canvas.width - PALLINA_RADIUS) {
                    p.speedX *= -0.9;
                    p.x = Math.max(PALLINA_RADIUS, Math.min(canvas.width - PALLINA_RADIUS, p.x));
                }

                CHIODINI.forEach(c => {
                    const dx = c.x - p.x;
                    const dy = c.y - p.y;
                    const dist = Math.hypot(dx, dy);
                    if (dist < CHIODINO_RADIUS + PALLINA_RADIUS) {
                        const angle = Math.atan2(dy, dx);
                        const force = c.bounce * 1.5;
                        p.speedX = Math.cos(angle) * force + (Math.random() - 0.5) * 2;
                        p.speedY = Math.sin(angle) * force - 2;
                        createParticles(p.x, p.y, 3, '#fff');
                        playBounce();
                    }
                });

                if (p.y >= canvas.height - ZONE_HEIGHT) {
                    p.landed = true;
                    const zoneIndex = Math.floor(p.x / (canvas.width / SCORE_ZONES.length));
                    if (BALL_ZONES.includes(zoneIndex)) {
                        remainingBalls = Math.min(remainingBalls + 1, 50);
                        remainingBallsDisplay.innerText = remainingBalls;
                        showScorePopup(p.x, p.y, "+1 BALL!", '#0f0');
                        playSound('bonusCompleteSound');
                    } else {
                        const points = SCORE_ZONES[zoneIndex];
                        const total = points * combo * comboMultiplier;
                        score += total;
                        updateScore();
                        showScorePopup(p.x, p.y, total > 0 ? `+${total}` : total);
                    }
                    combo = 0;
                    hideCombo();
                    checkLevelUp();
                }
                return p.y < canvas.height + 50;
            });
        }

        function updateScore() {
            scoreDisplay.innerText = score;
            if (score > highScore) {
                highScore = score;
                highScoreDisplay.innerText = highScore.toString().padStart(6, '0');
                hiScoreDisplay.innerText = highScore.toString().padStart(6, '0');
                localStorage.setItem('sadExtremeHiScore', highScore);
            }
        }

        function checkLevelUp() {
            if (score >= levelThreshold) {
                currentLevel++;
                levelThreshold *= 1.8;
                levelDisplay.innerText = currentLevel;
                showLevelUp();
                generateChiodini();
                playBgTrack();
            }
        }

        function showLevelUp() {
            levelUpMessage.style.opacity = 1;
            setTimeout(() => levelUpMessage.style.opacity = 0, 1500);
            playSound('levelUpSound');
            createParticles(canvas.width/2, canvas.height/2, 60, 'gold');
            shakeIntensity = 25;
        }

        function showScorePopup(x, y, text, color = 'gold') {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.innerText = text;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.style.color = color;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1200);
        }

        function showCombo() {
            comboText.innerText = `COMBO x${combo}`;
            comboText.style.opacity = 1;
        }

        function hideCombo() {
            comboText.style.opacity = 0;
        }

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: Math.random() * -10 - 5,
                    life: 30,
                    color
                });
            }
        }

        function draw() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (shakeIntensity > 0) {
                ctx.save();
                const dx = (Math.random() - 0.5) * shakeIntensity;
                const dy = (Math.random() - 0.5) * shakeIntensity;
                ctx.translate(dx, dy);
                shakeIntensity *= 0.9;
                if (shakeIntensity < 0.5) shakeIntensity = 0;
            }

            CHIODINI.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x, c.y, CHIODINO_RADIUS, 0, Math.PI*2);
                ctx.fillStyle = `hsl(${(currentLevel-1)*60}, 100%, 70%)`;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            });

            PALLINE.forEach(p => {
                if (p.landed) return;
                ctx.save();
                ctx.shadowColor = p.color;
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(p.x, p.y, PALLINA_RADIUS, 0, Math.PI*2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.restore();
            });

            particles = particles.filter(part => {
                part.x += part.vx;
                part.y += part.vy;
                part.vy += 0.3;
                part.life--;
                ctx.globalAlpha = part.life / 30;
                ctx.fillStyle = part.color;
                ctx.fillRect(part.x - 2, part.y - 2, 4, 4);
                return part.life > 0;
            });
            ctx.globalAlpha = 1;

            if (shakeIntensity > 0) ctx.restore();
        }

        function gameLoop() {
            updatePalline();
            draw();
            checkGameOver();
            requestAnimationFrame(gameLoop);
        }

        function checkGameOver() {
            if (remainingBalls <= 0 && PALLINE.every(p => p.landed) && !gameOver) {
                gameOver = true;
                finalScoreDisplay.innerText = score;
                gameOverOverlay.style.display = 'flex';
                sounds.bgTrack.pause();
                playSound('gameOverSound');
            }
        }

        highScore = parseInt(localStorage.getItem('sadExtremeHiScore') || '0');
        highScoreDisplay.innerText = highScore.toString().padStart(6, '0');
        hiScoreDisplay.innerText = highScore.toString().padStart(6, '0');

        startButton.addEventListener('click', () => {
            startOverlay.style.display = 'none';
            unlockAudio();
            gameLoop();
        });

        restartButton.addEventListener('click', () => {
            location.reload();
        });

        canvas.addEventListener('click', (e) => {
            if (gameOver || !audioUnlocked) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            createPallina(x);
        });
    </script>
</body>
</html>
